# dRICH development
To get a good idea of what version of each EIC software we're using, run the `check_branches.sh` script. Then, to build the `drich-dev` repository, we set the environment variables via
```bash
source environ.sh
```
and build each repository using the convenient `build.sh` script
```bash
./build.sh epic
./build.sh irt
./build.sh EDM4eic
./build.sh EICrecon # NOTE. Not compiling for me -- seems to be an issue w/ EDM4eic.
./build.sh juggler  # NOTE. Same as EICrecon.
./build.sh reconstruction_benchmarks
```

Note that the order in which we build is important. If we need to build everything, we can run the convenient `rebuild_all.sh` script (with the `clean` option if we want to build from scratch).

After this, we can build the local `drich-dev` by running `make`.

## Geometry
We can look at the dRICH geometry by running
```bash
geometry.sh -d
```
and then opening the output (in `geo/detector_geometry.root`) using [JSROOT](https://root.cern/js/latest/). If you plan to make a lot of changes to the geometry, it might be a good idea to download a local copy of [JSROOT](https://github.com/root-project/jsroot/releases).

We can take a look at the dRICH geometry constants with te `search_comact_params.sh` script
```bash
./search_compact_params.sh -e | grep DRICH
```
In the output, the first column is the name, the second the raw value, and the third the original formula. Values are in the standard DD4hep units, which (as defined [here](https://dd4hep.web.cern.ch/dd4hep/usermanuals/DD4hepManual/DD4hepManualch2.html)) are
```
static constexpr double centimeter       = 1.;
static constexpr double second           = 1.;
static constexpr double kiloelectronvolt = 1;
static constexpr double eplus            = 1.;
static constexpr double kelvin           = 1.;
static constexpr double mole             = 1.;
static constexpr double candela          = 1.;
static constexpr double radian           = 1.;
static constexpr double steradian        = 1.;
```

After changing any geometry constant, it's a good idea to run an overlap check. This is done automatically as a CI job for every commit associated with a pull request, but it can be done by hand (very computationally intensive) by running `overlap_check.sh`.

**NOTE.** There's more details into visualization, CI, and geometry [here](https://github.com/eic/drich-dev/blob/main/doc/tutorials/2-geometry-code.md).

## Running simulations
As seen in the [ddsim documentation](ddsim.md), `ddsim` doesn't have Cherenkov physics. Therefore, we need to use `npsim`. In `drich-dev`, there is a wrapper of `npsim` called `simulate.py`, which is on the root directory. Running it without arguments returns a usage guide.

We can run the script either with centrally generated files (see the [ddsim docs](ddsim.md)), files generated by us (see the [hepmc3 docs](hepmc3.md)), or just run standard pre-generated dRICH tests. The latter is the simplest. For example, if we want to aim 10 pions at the center of the aerogel sector, we do
```bash
./simulate.py -t1 -n10
# Test number <-/ \-> Number of events.
```

We can then view the result of the simulation using ROOT on the `out/sim.edm4hep.root` file. The dRICH hits are contained in the `DRICHHits` branch, which has the following structure:
```
DRICHHits
 +- cellID
 +- EDep
 +- time
 +- pathLength
 +- quality
 +- position
 |   +- x
 |   +- y
 |   +- z
 +- momentum
 |   +- x
 |   +- y
 |   +- z
 +- size
```
Out of these, what we probably care the most about is `position.x`, `position.y`, and `EDep`. We can see the hit distribution accross events on a colz plot by running
```C++
events->Draw("DRICHHits.position.y:DRICHHits.position.x>>hist(1000,-2000,2000, 1000,-2000,2000)", "DRICHHits.EDep", "COLZ");
```

We can also look at the hits on an event-by-event basis by using the integrated `event_display` tool
```bash
event_display d s out/sim.edm4hep.root n 0 0
```
To what each option means, please see the usage by running the script with no input. By changing `n` to `i`, we can take an interactive look at a particular event
```bash
event_display d s out/sim.edm4hep.root i 6
```
